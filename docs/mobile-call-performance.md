# Анализ нагрузки при мобильном видеозвонке

## Наблюдения по коду

- **Микширование видео через Canvas на 60 FPS.** В `VideoStreamMixer` кадры двух потоков постоянно отрисовываются в `canvas` и перехватываются через `captureStream(60)`, что фиксирует частоту 60 кадров в секунду и запускает бесконечный цикл `requestAnimationFrame`. На мобильных устройствах такое перерисовывание на полном разрешении приводит к высокой нагрузке на CPU/GPU и ускоренному расходу батареи.【F:frontend/src/lib/videoMixer.ts†L32-L127】
- **Постоянный анализ аудио-потока.** `AudioStreamMixer` создает `AudioContext`, подключает `AnalyserNode` и в каждом кадре браузера считывает спектральные данные для регулировки громкости системного звука. Это создает дополнительную постоянную работу для процессора даже если громкость не меняется, а также не останавливается автоматически при выключенном микрофоне пользователя.【F:frontend/src/lib/audioMixer.ts†L46-L141】
- **Запрос видеопотока без ограничения разрешения.** При инициализации локального потока `getUserMedia` вызывается только с `facingMode: 'user'`, без явного указания допустимого разрешения или частоты кадров. Современные телефоны могут отдавать 1080p/4K на 60 FPS, что значительно нагружает датчик камеры, кодек и канал передачи.【F:frontend/src/features/call/hooks/useLocalMedia.ts†L226-L242】【F:frontend/src/features/call/utils/mediaConstraints.ts†L23-L34】
- **Восстановление потоков при каждом возврате во вкладку.** При любом переходе во вкладку приложение пытается заново получить `getUserMedia`, даже если текущие дорожки «живы». Это может дергать камеру и создаёт всплески нагрузки и расхода энергии на мобильных устройствах при переключении приложений.【F:frontend/src/features/call/hooks/useLocalMedia.ts†L210-L244】

## Предложения по оптимизации

1. **Адаптивное качество видеопотоков.** Добавить конфигурацию, которая будет ограничивать целевое разрешение (например, 720p/30 FPS) при подключении с мобильных устройств, и понижать его при перегрузке CPU/слабом соединении. Это снизит нагрузку на кодек, уменьшит тепловыделение и расход батареи.
2. **Оптимизация canvas-монтажа.** Снижать частоту отрисовки в `VideoStreamMixer` (например, использовать 30 FPS или `requestVideoFrameCallback` для синхронизации с исходным потоком) и отключать рендер при свернутом UI/отсутствии второго окна. Это уменьшит количество операций рисования и нагрузку на GPU.
3. **Троттлинг аудио-анализатора.** Вместо вызова `requestAnimationFrame` на каждый кадр, измерять громкость с меньшей частотой (например, раз в 100–200 мс через `setInterval`) и останавливать `AudioContext`, когда микрофон выключен. Это сократит постоянную нагрузку на CPU и сэкономит энергию.
4. **Бережное восстановление медиапотока.** Перед повторным вызовом `getUserMedia` при возврате во вкладку проверять `readyState` дорожек и пересоздавать поток только при необходимости. Это снизит количество лишних инициализаций камеры/микрофона, что уменьшит энергопотребление и потенциальные глюки на мобильных устройствах.

## Задачи для реализации

1. **"Ввести адаптивные ограничения качества локального видео"** – определить логики выбора подходящих `MediaTrackConstraints` на основе типа устройства/состояния сети и обновить `useLocalMedia` так, чтобы камера запрашивалась с безопасным базовым разрешением и частотой кадров. Цель: снизить нагрузку на мобильные камеры и кодеки без заметной потери качества связи.
2. **"Перевести VideoStreamMixer на экономичный режим рендеринга"** – настроить частоту `canvas.captureStream` и расписание перерисовок так, чтобы в мобильном сценарии использовалось не более 30 FPS и отрисовка приостанавливалась, когда превью не отображается. Цель: уменьшить нагрузку на графический процессор и продлить время работы от батареи при звонке.
3. **"Оптимизировать анализ микрофона в AudioStreamMixer"** – заменить бесконечный `requestAnimationFrame` на менее частые проверки и отключать `AudioContext`, когда микрофон выключен или пользователь не говорит. Цель: сократить постоянное использование CPU при звонке.
4. **"Переписать восстановление локального потока после возврата в приложение"** – добавить проверку готовности текущих `MediaStreamTrack` и запускать `restartLocalStream` только при фактическом завершении дорожек. Цель: исключить лишние `getUserMedia` на мобильных устройствах и избежать скачков нагрузки при переключении между приложениями.
